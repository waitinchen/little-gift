# 禮物連結系統規格

## 目的
定義禮物連結的創建、分享和兌換流程，實現送禮者付費、收禮者填地址的雙向流程。

## 需求

### 需求：禮物連結創建
系統必須在訂單完成後自動生成禮物連結。

#### 場景：成功創建連結
- 當用戶完成禮物購買和付款
- 則系統自動生成唯一的禮物連結
- 連結包含：唯一令牌、訂單ID、狀態（waiting）
- 並關聯送禮者用戶ID

#### 場景：連結唯一性
- 每個禮物連結必須有唯一的令牌
- 令牌格式：32位隨機字符串
- 系統必須確保令牌不重複

### 需求：禮物連結分享
系統必須提供禮物連結的分享功能。

#### 場景：分享連結
- 當送禮者獲得禮物連結
- 則可以通過多種方式分享給收禮者
- 分享方式：簡訊、LINE、Email、直接複製連結

### 需求：收禮者兌換
收禮者必須能夠通過連結填寫收貨信息。

#### 場景：成功兌換
- 當收禮者訪問有效的禮物連結
- 且連結狀態為 waiting
- 則系統顯示禮物信息和兌換表單
- 收禮者填寫：姓名、電話、地址等收貨信息
- 系統更新連結狀態為 redeemed
- 並記錄兌換時間

#### 場景：重複兌換
- 當收禮者嘗試兌換已兌換的連結
- 則系統顯示「此禮物已兌換」訊息

#### 場景：無效連結
- 當收禮者訪問不存在的連結
- 則系統顯示「無效的禮物連結」錯誤

### 需求：收貨信息驗證
系統必須驗證收禮者填寫的信息。

#### 必填字段
- 收禮者姓名
- 收禮者電話
- 收貨地址（地址1、城市、郵遞區號）
- 國家代碼（默認台灣 TW）

#### 驗證規則
- 姓名：不能為空，長度 1-50 字符
- 電話：台灣手機號碼格式驗證
- 地址：不能為空，長度 1-200 字符
- 郵遞區號：台灣郵遞區號格式驗證

### 需求：訂單狀態同步
系統必須同步更新相關訂單狀態。

#### 場景：兌換完成
- 當收禮者成功兌換禮物連結
- 則系統更新訂單狀態為「等待發貨」
- 並觸發發貨通知

## 技術實現

### 數據庫設計
- 禮物連結表：token, order_id, sender_id, recipient_id, status, redeemed_at
- 狀態：waiting, redeemed, expired

### API 端點
- GET /store/gift-links/:orderId - 獲取禮物連結
- POST /store/gift-links/:token/redeem - 兌換禮物
- GET /store/gift-links/:token - 查看禮物信息

### 安全措施
- 令牌使用加密算法生成
- 連結有效期限制（如 30 天）
- 防止暴力破解令牌

### 通知系統
- 兌換成功通知送禮者
- 發貨通知收禮者
- 支持 LINE 通知集成
